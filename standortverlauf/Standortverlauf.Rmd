---
title: "Mapping Google location history"
author: "Dr. Shirin Glander"
date: '`r Sys.Date()`'
output: html_document
---


The Google location history can be downloaded from your Google account under [http://takeout.google.com/](http://takeout.google.com/). Make sure you only tick *"location history"* for download, otherwise it will pobably take super long if you ask to get all your Google data.

It is saved as a .json file and can be loaded with the [jsonlite](https://cran.r-project.org/web/packages/jsonlite/index.html) package.

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
library(jsonlite)
system.time(x <- fromJSON("U:/Github_blog/Takeout/Standortverlauf/Standortverlauf.json"))
```

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
# extracting the locations dataframe
loc = x$locations

# converting time column from posix milliseconds into a readable time scale
loc$time = as.POSIXct(as.numeric(x$locations$timestampMs)/1000,
                      origin = "1970-01-01")

# converting longitude and latitude from E7 to GPS coordinates
loc$lat = loc$latitudeE7 / 1e7
loc$lon = loc$longitudeE7 / 1e7
```

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
head(loc)
```

# How many data points did it record?

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
nrow(loc)
```

# Over which period of time?

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
summary(loc$time)
```

# Plotting

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
library(ggplot2)
library(ggmap)
```

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
germany <- get_map(location = 'Germany', zoom = 5)

ggmap(germany) + geom_point(data = loc, aes(x = lon, y = lat, color = -accuracy), alpha = .1) + 
  theme(legend.position="right") + labs(x="Longitude", y="Latitude", title="Location history Europe") +
  scale_colour_gradient(low = "blue", high = "red")
```


```{r echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
munster <- get_map(location = 'Munster', zoom = 12)

ggmap(munster, extent = "panel", maprange=FALSE) +
  stat_bin2d(aes(x = lon, y = lat), data = loc, bins = 200, geom = "tile") +
  scale_fill_gradient(low = "blue", high = "red") +
  theme(legend.position="right") + labs(x="Longitude", y="Latitude", title="Location history MÃ¼nster")
```

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
map <- get_map(location = 'London', zoom = 12)

ggmap(map, darken = c(0.3, "white")) + geom_point(data = loc, aes(x = lon, y = lat), color = "red", alpha = .1) +
  theme(legend.position="right") + labs(x="Longitude", y="Latitude", title="Location history London")

```

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
loc_2 <- loc[which(!is.na(loc$velocity)), ]

munster <- get_map(location = 'Munster', zoom = 13)

ggmap(munster) + geom_point(data = loc_2, aes(x = lon, y = lat, color = velocity), alpha = .1) + 
  theme(legend.position="right") + labs(x="Longitude", y="Latitude", title="Location history Europe") +
  scale_colour_gradient(low = "blue", high = "red")
```

# How much distance did I travel?

# Activities

Here, Google guesses my activity based on distance travelled per time.

```{r eval = FALSE, inclue = FALSE, echo = TRUE, message = FALSE, warning = FALSE, cache=TRUE}
for(i in 1:length(loc$activitys)) {
  print(i)
  
  x <- loc$activitys[i]
  
  if(!is.null(x[[1]])) {
    act <- x[[1]]
    
    for(j in 1:nrow(act)) {
      
      act_ts <- as.POSIXct(as.numeric(act$timestampMs[j])/1000, origin = "1970-01-01")
      act_data <- act$activities[j][[1]]
      act_data$time <- act_ts

      if(j == 1) {act_df <- act_data}
      if(j > 1) {act_df <- rbind(act_df, act_data)}
    }
    
    if(!exists("activities")) {
      activities <- act_df
    } else {
      activities <- rbind(activities, act_df)
    }
  }
}
```


