---
title: "Merry R-mas - sin taxes in the US since 1862"
author: "Shirin Glander"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: github
---

ttbbeer: A package for US Brewery data sets.

The ttbbeer package includes at current state, one data set of a collection of 10 years (2006 - 2015) worth of data on materials used at U.S. breweries in pounds reported by the Brewer's Report of Operations and the Quarterly Brewer's Report of Operations forms, ready for data analysis.

An R data package of beer statistics from U.S. Department of the Treasury, Alcohol and Tobacco Tax and Trade Bureau (TTB)

This package provides the one data set for materials used at U.S. breweries as listed in the Beer Monthly Statistical Releases, and eight data sets for historical tax rates of distilled spirits, wine, beer, champagne, and tobacco.

The motivation behind this package was to provide analysis-ready data sets as the original data for the beermaterials is in PDF format which can be difficult to read into R, given the small ecosystem of PDF parsing R packages such as: tm, and tabulizer. Other goals of this package are to provide more data sets to the R ecosystem for beer analytics from open government data portals.

Happy Holidays and Cheers!

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=FALSE, fig.width = 6, fig.height = 5, fig.align = "center"}
library(ttbbeer)

beertax$tax <- "BEER"

champagnetax$tax <- "CHAMPAGNE"

spirittax$tax <- "SPIRIT"

tobaccotax$ITEM <- toupper(tobaccotax$ITEM)
tobaccotax$tax <- paste("TOBACCO", tobaccotax$ITEM, sep = " ")
tobaccotax_2 <- tobaccotax[, -1]
tobaccotax_2[18, 2] <- "1977-01-31"
tobaccotax_2[18, 1] <- "1977-01-01"

winetax14$tax <- "WINE 14%"

winetax1421$tax <- "WINE 14-21%"

winetax2124$tax <- "WINE 21-24%"

tax <- rbind(beertax, champagnetax, spirittax, tobaccotax_2, winetax14, winetax1421, winetax2124)

tax_2 <- tax
tax_2$ID <- paste(tax_2$tax, rownames(tax_2), sep = "_")
head(tax_2)
```

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=FALSE, fig.width = 10, fig.height = 6, fig.align = "center"}
library(tidyr)
tax_gather <- tax_2 %>%
  gather(dat_column, Date, FROM:TO)
tax_gather$group <- gsub(" .*", "", tax_gather$tax)
```

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=FALSE, fig.width = 10, fig.height = 6, fig.align = "center"}
library(ggplot2)
theme_set(theme_bw())

ggplot(tax_gather, aes(x = Date, y = RATE, color = tax)) +
  geom_point(size = 1.5, alpha = 0.6) +
  geom_line() +
  facet_wrap(~group, ncol = 3, scales = "free_y") +
  labs(
    y = "Tax rate in %"
  )
```

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=FALSE, fig.width = 12, fig.height = 5, fig.align = "center"}
d <- data.frame(xmin = as.Date(c("1861-04-12", "1914-07-28", "1920-01-16", "1939-11-01")), 
                ymin = -Inf, 
                xmax = as.Date(c("1865-04-09", "1918-11-11", "1933-12-05", "1945-05-08")), 
                ymax = Inf, 
                description = c("Civial War", "WW1", "Prohibition", "WW2"),
                pos_y = as.numeric(rep(c("20", "18"), 2)))
d$pos_x <- as.Date(NA)

for (i in 1:nrow(d)){
  d[i, "pos_x"] <- as.Date(as.character(median(c(d$xmin[i], d$xmax[i]))))
}

tax_gather$group2 <- ifelse(tax_gather$group == "TOBACCO", "TOBACCO", "ALCOHOL")

ggplot() +
  geom_rect(data = d, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), alpha=0.2) +
  geom_label(data = d, aes(pos_x, pos_y, label = description), check_overlap = TRUE) +
  geom_point(data = subset(tax_gather, group2 == "ALCOHOL"), aes(x = Date, y = RATE, color = tax), size = 1.5, alpha = 0.6) +
  geom_line(data = subset(tax_gather, group2 == "ALCOHOL"), aes(x = Date, y = RATE, color = tax)) +
  facet_wrap(~group2, ncol = 1, scales = "free_y") +
  labs(
    y = "Tax rate in %"
  )
```

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=FALSE, fig.width = 12, fig.height = 5, fig.align = "center"}
library(gganimate)

p <- ggplot(tax_gather, aes(x = Date, y = RATE, color = tax, frame = tax)) +
  geom_point(size = 1.5, alpha = 0.6) +
  geom_line()

#gganimate(p, filename = "taxes_by_tax.gif")
#gganimate(p, filename = "taxes_by_tax.mp4")
```

![](taxes_by_tax.gif)

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=FALSE, fig.width = 10, fig.height = 5, fig.align = "center"}
tax_gather$year <- gsub("-.*", "", tax_gather$Date)

(p2 <- ggplot(subset(tax_gather, dat_column == "FROM"), aes(x = Date, y = tax, size = RATE, color = tax, frame = year)) +
  geom_point(alpha = 0.6) +
   guides(color = FALSE))

#gganimate(p2, filename = "taxes_by_year.gif")
#gganimate(p2, filename = "taxes_by_year.mp4")
```

---

```{r echo = TRUE, message = FALSE, warning = FALSE, cache=FALSE, fig.width = 12, fig.height = 5, fig.align = "center"}
data("beermaterials")

head(beermaterials)

```


------------------

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=4, fig.align="center", cache=FALSE}
sessionInfo()
```
