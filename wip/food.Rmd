---
title: "Predicting food preferences with sparklyr"
author: "Dr. Shirin Glander"
date: '`r Sys.Date()`'
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: github
---

Obviously, the power of Spark is in applying it to large datasets with many features (like image categorisation, etc.). Because that's not very handy for demonstration purposes, I am here showing the principles on a small dataset.

---

http://spark.rstudio.com/

http://spark.apache.org/

http://spark.apache.org/faq.html

```{r eval=FALSE}
# install a local version of Spark
library(sparklyr)
spark_install(version = "2.0.0")
```

```{r}
# connecting to a local Spark instance
library(sparklyr)
sc <- spark_connect(master = "local", version = "2.0.0")
```

---

The raw data behind the story "The FiveThirtyEight International Food Association's 2014 World Cup" http://fivethirtyeight.com/features/the-fivethirtyeight-international-food-associations-2014-world-cup/. For all the countries below, the response to the following question is presented: "Please rate how much you like the traditional cuisine of X"

5: I love this country's traditional cuisine. I think it's one of the best in the world.

4: I like this country's traditional cuisine. I think it's considerably above average.

3: I'm OK with this county's traditional cuisine. I think it's about average.

2: I dislike this country's traditional cuisine. I think it's considerably below average.

1: I hate this country's traditional cuisine. I think it's one of the worst in the world.

N/A: I'm unfamiliar with this country's traditional cuisine.

```{r eval=FALSE}
library(fivethirtyeight)

# backup copy:
food_world_cup_copy <- food_world_cup

food_world_cup[food_world_cup == "N/A"] <- NA
food_world_cup[, 9:48][is.na(food_world_cup[, 9:48])] <- 0
food_world_cup$gender <- as.factor(food_world_cup$gender)
food_world_cup$location <- as.factor(food_world_cup$location)
food_world_cup[9:48] <- sapply(food_world_cup[9:48], as.numeric)
```

```{r eval=FALSE, message=FALSE, warning=FALSE}
library(mice)

dataset_impute <- mice(food_world_cup[, -c(1, 2)],  print = FALSE)
food_world_cup <- cbind(food_world_cup[, 2, drop = FALSE], mice::complete(dataset_impute, 1))
```

```{r echo=FALSE, eval=FALSE}
save(food_world_cup, file = "food_world_cup.RData")
```

```{r echo=FALSE}
load("food_world_cup.RData")
```

```{r}
food_world_cup <- copy_to(sc, food_world_cup)
head(food_world_cup)
```

```{r message=FALSE, warning=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggrepel)

my_theme <- function(base_size = 12, base_family = "sans"){
  theme_minimal(base_size = base_size, base_family = base_family) +
  theme(
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.title = element_text(size = 14),
    panel.grid.major = element_line(color = "grey"),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "aliceblue"),
    strip.background = element_rect(fill = "lightgrey", color = "grey", size = 1),
    strip.text = element_text(face = "bold", size = 12, color = "black"),
    legend.position = "right",
    legend.justification = "top", 
    panel.border = element_rect(color = "grey", fill = NA, size = 0.5)
  )
}
```

---

http://spark.rstudio.com/mllib.html

```{r}
food_world_cup <- tbl(sc, "food_world_cup") %>%
  ft_string_indexer(input_col = "interest", output_col = "interest_idx") %>%
  ft_string_indexer(input_col = "gender", output_col = "gender_idx") %>%
  ft_string_indexer(input_col = "age", output_col = "age_idx") %>%
  ft_string_indexer(input_col = "household_income", output_col = "household_income_idx") %>%
  ft_string_indexer(input_col = "education", output_col = "education_idx") %>%
  ft_string_indexer(input_col = "location", output_col = "location_idx") %>%
  ft_string_indexer(input_col = "knowledge", output_col = "knowledge_idx")
```

```{r message=FALSE, warning=FALSE, fig.width=15}
food_world_cup_gather <- food_world_cup %>%
  collect %>%
  gather(country, value, algeria:vietnam)
                                 
food_world_cup_gather$value <- as.numeric(food_world_cup_gather$value)
food_world_cup_gather$country <- as.factor(food_world_cup_gather$country)

order <- aggregate(na.omit(food_world_cup_gather)$value, by = list(country = na.omit(food_world_cup_gather)$country), FUN = sum)

food_world_cup_gather$country <- factor(food_world_cup_gather$country, levels = order$country[order(order$x, decreasing = TRUE)])
```

```{r message=FALSE, warning=FALSE, fig.width=8}
ggplot(food_world_cup_gather, aes(x = country, y = value, fill = gender)) +
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Set1") +
  my_theme()
```

```{r fig.width=8}
library(exprAnalysis)

heat_data <- na.omit(as.data.frame(food_world_cup))[, -c(1:7, 48:54)]
heat_data <- heat_data[which(rowSums(heat_data) > 0), ]

continent <- c("Africa", "South America", "Australia", "Europe", "Europe", "South America", "Africa", "South America", "Asia",
                         "South America", "South America", "Europe", "Central America", "South America", "Europe", "Africa", "Europe",
                         "Europe", "Africa", "Europe", "Central America", "Asia", "Asia", "Europe", "Europe", "Africa", "Asia",
                         "Central America", "Africa", "Europe", "Asia/ Europe", "Asia", "Europe", "Europe", "Asia", "Europe",
                         "Asia/ Europe", "North America", "South America", "Asia")

library(RColorBrewer)
#brewer.pal(8, "Set1")
colors <- ifelse(continent == "Africa", "#E41A1C",
                 ifelse(continent == "South America", "#377EB8",
                        ifelse(continent == "Australia", "#4DAF4A",
                               ifelse(continent == "Europe", "#984EA3",
                                      ifelse(continent == "Asia", "#FF7F00",
                                             ifelse(continent == "Central America", "#FFFF33",
                                                    ifelse(continent == "North America", "#A65628",
                                                           ifelse(continent == "Asia/ Europe", "#F781BF", NA
                                                           ))))))))


heatmaps(heat_data, method_dist = "manhattan", method_hclust = "complete", main = "", samplecols = colors)
legend("left", c("Africa", "South America", "Australia", "Europe", "Asia", "Central America", "North America", "Asia/ Europe"),
       col = brewer.pal(8, "Set1"), pch = 19, cex = 0.7)
```

```{r fig.width=8, fig.height=8}
pca <- food_world_cup %>%
  ml_pca(features = paste(colnames(food_world_cup)[-c(1:7, 48:54)]))

groups <- as.factor(colors)
labels <- rownames(as.data.frame(pca$components))

ggplot(data = as.data.frame(pca$components), aes(x = PC1, y = PC2, color = groups, label = labels)) + 
  geom_point(size = 2, alpha = 0.6) +
  geom_text_repel() +
  labs(x = paste0("PC1: ", round(pca$explained.variance[1], digits = 2) * 100, "% variance"),
       y = paste0("PC2: ", round(pca$explained.variance[2], digits = 2) * 100, "% variance")) +
  my_theme() + 
  guides(fill = FALSE, color = FALSE)
```

```{r}
pca_func <- function(pcaOutput2, group_name){
    centroids <- aggregate(cbind(PC1, PC2) ~ groups, pcaOutput2, mean)
    conf.rgn  <- do.call(rbind, lapply(unique(pcaOutput2$groups), function(t)
          data.frame(groups = as.character(t),
                     ellipse(cov(pcaOutput2[pcaOutput2$groups == t, 1:2]),
                           centre = as.matrix(centroids[centroids$groups == t, 2:3]),
                           level = 0.95),
                     stringsAsFactors = FALSE)))
        
    plot <- ggplot(data = pcaOutput2, aes(x = PC1, y = PC2, group = groups, color = groups)) + 
      geom_polygon(data = conf.rgn, aes(fill = groups), alpha = 0.2) +
      geom_point(size = 2, alpha = 0.6) + 
      scale_color_brewer(palette = "Set1") +
      scale_fill_brewer(palette = "Set1") +
      labs(color = paste(group_name),
           fill = paste(group_name),
           x = paste0("PC1: ", round(pcaOutput$pov[1], digits = 2) * 100, "% variance"),
           y = paste0("PC2: ", round(pcaOutput$pov[2], digits = 2) * 100, "% variance")) +
      my_theme()
    
    return(plot)
}
```

```{r fig.width=5, fig.height=4, message=FALSE, warning=FALSE}
library(pcaGoPromoter)
pcaOutput <- pca(t(as.data.frame(food_world_cup)[-c(1:7, 48:54)]), printDropped = FALSE, scale = TRUE, center = TRUE)
pcaOutput2 <- as.data.frame(pcaOutput$scores)

pcaOutput2$groups <- as.data.frame(food_world_cup)$knowledge

pca1 <- pca_func(pcaOutput2, group_name = "knowledge")
```

```{r fig.width=5, fig.height=4}
pcaOutput2$groups <- as.data.frame(food_world_cup)$interest
pca2 <- pca_func(pcaOutput2, group_name = "interest")
```

```{r fig.width=5, fig.height=4}
pcaOutput2$groups <- as.data.frame(food_world_cup)$age
pca3 <- pca_func(pcaOutput2, group_name = "age")
```

```{r fig.width=6, fig.height=4}
pcaOutput2$groups <- as.data.frame(food_world_cup)$household_income
pca4 <- pca_func(pcaOutput2, group_name = "household_income")
```

```{r fig.width=7, fig.height=4}
pcaOutput2$groups <- as.data.frame(food_world_cup)$education
pca5 <- pca_func(pcaOutput2, group_name = "education")
```

```{r fig.width=6, fig.height=4}
pcaOutput2$groups <- as.data.frame(food_world_cup)$location
pca6 <- pca_func(pcaOutput2, group_name = "location")
```

```{r fig.width=20, fig.height=10, message=FALSE, warning=FALSE}
library(gridExtra)
library(grid)

grid.arrange(pca1, pca2, pca3, pca4, pca5, pca6, ncol = 3)
```

---

```{r}
partitions <- food_world_cup %>%
  select(algeria:vietnam) %>%
  sdf_partition(training = 0.75, test = 0.25, seed = 753)
```

```{r eval=FALSE}
for(response in colnames(partitions$training)) {
  print(response)
  
  features <- colnames(partitions$training)[-which(colnames(partitions$training) == response)]
  
  fit <- partitions$training %>%
    ml_random_forest(intercept = FALSE, response = response, features = features, type = "classification")

  pred <- sdf_predict(fit, partitions$test) %>%
    collect
  
  pred_2 <- as.data.frame(table(pred[[response]], pred$prediction))
  pred_2$response <- response
  
  pred_sc <- pred[, -c(41, 42)]
  pred_sc <- copy_to(sc, pred_sc, overwrite = TRUE)
  
  feature_imp <- ml_tree_feature_importance(sc, fit)
  feature_imp$response <- response
  
  f1 <- ml_classification_eval(pred_sc, response, "prediction", metric = "f1")
  wP <- ml_classification_eval(pred_sc, response, "prediction", metric = "weightedPrecision")
  wR <- ml_classification_eval(pred_sc, response, "prediction", metric = "weightedRecall")
  
  ml_eval <- data.frame(response = response,
                        f1 = f1,
                        weightedPrecision = wP,
                        weightedRecall = wR)
  
  if (response == "algeria") {
    feature_imp_df <- feature_imp
    ml_eval_df <- ml_eval
    pred_df <- pred_2
  } else {
    feature_imp_df <- rbind(feature_imp_df, feature_imp)
    ml_eval_df <- rbind(ml_eval_df, ml_eval)
    pred_df <- rbind(pred_df, pred_2)
  }
}
```


```{r echo=FALSE, eval=FALSE}
save(feature_imp_df, file = "feature_imp_df.RData")
save(ml_eval_df, file = "ml_eval_df.RData")
save(pred_df, file = "pred_df.RData")
```

```{r echo=FALSE}
load("feature_imp_df.RData")
load("ml_eval_df.RData")
load("pred_df.RData")
```

```{r fig.width=10}
order <- ml_eval_df$response[order(ml_eval_df$f1, decreasing = TRUE)]

gather(ml_eval_df, x, y, f1:weightedRecall) %>%
  mutate(response = factor(response, levels = order)) %>%
  ggplot(aes(x = response, y = y, color = x, fill = x)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer(palette = "Set1") +
  my_theme()
```

The reason why cameroon, etc. had such high accuracy was that they had majority of 0 votes, meaning that the likelihood of correctly classifying a sample as 0 is high!

- leave out 0s?

```{r message=FALSE, warning=FALSE, fig.width=10}
as.data.frame(food_world_cup)[-c(1:7, 48:54)] %>%
  gather(x, y, -cameroon) %>%
  ggplot(aes(x = x, y = cameroon, color = y)) +
  geom_jitter(alpha = 0.2) +
  scale_color_gradient(low = "blue", high = "red") +
  my_theme()
```

```{r message=FALSE, warning=FALSE, fig.width=10}
as.data.frame(food_world_cup)[-c(1:7, 48:54)] %>%
  gather(x, y, -ivory_coast) %>%
  ggplot(aes(x = x, y = ivory_coast, color = y)) +
  geom_jitter(alpha = 0.2) +
  scale_color_gradient(low = "blue", high = "red") +
  my_theme()
```

```{r message=FALSE, warning=FALSE, fig.width=10}
as.data.frame(food_world_cup)[-c(1:7, 48:54)] %>%
  gather(x, y, -nigeria) %>%
  ggplot(aes(x = x, y = nigeria, color = y)) +
  geom_jitter(alpha = 0.2) +
  scale_color_gradient(low = "blue", high = "red") +
  my_theme()
```

```{r message=FALSE, warning=FALSE, fig.width=10}
as.data.frame(food_world_cup)[-c(1:7, 48:54)] %>%
  gather(x, y, -italy) %>%
  ggplot(aes(x = x, y = italy, color = y)) +
  geom_jitter(alpha = 0.2) +
  scale_color_gradient(low = "blue", high = "red") +
  my_theme()
```

------------------

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=4, fig.align="center", cache=FALSE}
sessionInfo()
```
