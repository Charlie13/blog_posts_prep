---
title: "QTL plots with ggplot2"
author: "Shirin Glander"
date: "February 9, 2017"
output: html_document
---

```{r}
library(qtl)

data(hyper)

plotMissing(hyper, reorder=TRUE)
plotMap(hyper)
plotPheno(hyper, pheno.col=1)
plotMap(hyper, chr=c(1, 4, 6, 7, 15), show.marker.names=TRUE)
```

```{r}
hyper <- est.rf(hyper)
plotRF(hyper)
plotRF(hyper, chr=c(1,4))
```

```{r}
hyper <- calc.errorlod(hyper, error.prob=0.01)
plotGeno(hyper, chr=16, ind=c(24:34, 71:81))

```

```{r}
plotInfo(hyper)
plotInfo(hyper, chr=c(1,4,15), method="entropy")
plotInfo(hyper, chr=c(1,4,15), method="variance")
```

```{r}
hyper <- calc.genoprob(hyper, step=1, error.prob=0.01)
out.em <- scanone(hyper, model = "normal")
out.hk <- scanone(hyper, method="hk", model = "normal")

hyper <- sim.geno(hyper, step=2, n.draws=16, error.prob=0.01)
out.imp <- scanone(hyper, method="imp", model = "normal")

plot(out.em, out.hk, out.imp, chr=c(1,4,15))
plot(out.em, chr=c(1,4,15))
plot(out.hk, chr=c(1,4,15), col="blue", add=TRUE)
plot(out.imp, chr=c(1,4,15), col="red", add=TRUE)
abline(h = 3, lty = 2)
legend("topright", c("EM algorithm","Mult. imputation"), col = c("blue", "red"), lty = 1, lwd = 3)
```

```{r}
operm.hk <- scanone(hyper, pheno.col = 1, model = "normal", method="hk", n.perm=1000)
summary(operm.hk, alpha = 0.05)
summary(out.hk, perms=operm.hk, alpha=0.05, pvalues=TRUE)
```



```{r fig.width=15, fig.height=3}
qtl_plot(input = out.hk)
```

```{r fig.width=8, fig.height=6}
qtl_plot(input = rbind(data.frame(out.em, method = "EM algorithm"), 
                       data.frame(out.hk, method = "Haley-Knott regression"), 
                       data.frame(out.imp, method = "Multiple imputation")), 
         chrs = c(1, 4, 14, 15), 
         lod = summary(operm.hk, alpha=0.05)[1], 
         rug = TRUE, 
         ncol = 2,
         labels = as.data.frame(summary(out.hk, perms=operm.hk, alpha=0.05, pvalues=TRUE)))
```

```{r}
data(badorder)
summary(badorder)
plot(badorder)

badorder <- est.rf(badorder)
plotRF(badorder)

newmap <- est.map(badorder, verbose=TRUE)
plotMap(badorder, newmap)

pull.map(badorder, chr=2)
pull.map(badorder, chr=3)

badorder <- movemarker(badorder, "D2M937", 3, 48)
badorder <- movemarker(badorder, "D3M160", 2, 28.8)

plotRF(badorder, chr=2:3)

```

```{r}
badorder <- calc.genoprob(badorder, step=1, error.prob=0.01)
out.em <- scanone(badorder)
out.hk <- scanone(badorder, method="hk")

badorder <- sim.geno(badorder, step=2, n.draws=16, error.prob=0.01)
out.imp <- scanone(badorder, method="imp")

plot(out.em, out.hk, out.imp, chr=c(1,4,15))
plot(out.em, chr=c(1,4,15))
plot(out.hk, chr=c(1,4,15), col="blue", add=TRUE)
plot(out.imp, chr=c(1,4,15), col="red", add=TRUE)
abline(h = 3, lty = 2)
legend("topright", c("EM algorithm","Mult. imputation"), col = c("blue", "red"), lty = 1, lwd = 3)
```

```{r}
operm.hk <- scanone(badorder, method="hk", n.perm=1000)
summary(operm.hk, alpha = 0.05)
summary(out.hk, perms=operm.hk, alpha=0.05, pvalues=TRUE)
```

```{r fig.width=15, fig.height=3}
qtl_plot(input = out.hk, chrs = c(1, 3))
```

```{r fig.width=8, fig.height=3}
qtl_plot(input = rbind(data.frame(out.em, method = "EM algorithm"), 
                       data.frame(out.hk, method = "Haley-Knott regression"), 
                       data.frame(out.imp, method = "Multiple imputation")), 
         chrs = c(1, 3), 
         lod = summary(operm.hk, alpha=0.05)[1], 
         rug = TRUE, 
         ncol = 2,
         labels = as.data.frame(summary(out.hk, perms=operm.hk, alpha=0.05, pvalues=TRUE)))
```

```{r}
data(listeria)
summary(listeria)
plot(listeria)
plotMissing(listeria)
listeria$pheno$logSurv <- log(listeria$pheno[,1])
plot(listeria)

listeria <- est.rf(listeria)
plotRF(listeria)
plotRF(listeria, chr=c(5,13))

newmap <- est.map(listeria, error.prob=0.01)
plotMap(listeria, newmap)
listeria <- replace.map(listeria, newmap)

listeria <- calc.errorlod(listeria, error.prob=0.01)
top.errorlod(listeria)
top.errorlod(listeria, cutoff=3.5)
plotGeno(listeria, chr=13, ind=61:70, cutoff=3.5)

listeria <- calc.genoprob(listeria, step=2)
out.2p <- scanone(listeria, pheno.col=3, model="2part", upper=TRUE)

summary(out.2p)
summary(out.2p, threshold=4.5)

summary(out.2p, format="allpeaks", threshold=3)
summary(out.2p, format="allpeaks", threshold=c(4.5,3,3))

plot(out.2p)
plot(out.2p, lodcolumn=2)
plot(out.2p, lodcolumn=1:3, chr=c(1,5,13,15))

operm.2p <- scanone(listeria, model="2part", pheno.col=3,
upper=TRUE, n.perm=25)
summary(operm.2p, alpha=0.05)

summary(out.2p, format="allpeaks", perms=operm.2p, alpha=0.05, pvalues=TRUE)

```

```{r }
library(ggplot2)
library(tidyr)

qtl_plot <- function(input, model = "normal", chrs = NA, lod = NA, rug = FALSE, ncol = NA, labels = NA) {
  
  if (model == "2part") {
    input <- gather(input, group, lod, lod.p.mu:lod.mu)
  }
    
  if (!is.na(chrs)[1]) {
    input <- input[as.character(input$chr) %in% chrs, ]
  }
  
  if (is.na(ncol)) {
    ncol <- length(unique(input$chr))
  }
  
  if(!is.na(labels)[1]) {
    labels$name <- rownames(labels)
  }

  
  ggplot(input, aes(x = pos, y = lod)) + {
    if(!is.na(lod)) geom_hline(yintercept = lod, linetype = "dashed")
  } + {
    if(rug) geom_rug(size = 0.1, sides = "b")
  } + {
    if (!is.null(input$method)) geom_line(aes(color = method), size = 2, alpha = 0.6)
  } + {
    if (!is.null(input$group)) geom_line(aes(color = group), size = 2, alpha = 0.6)
  } + {
    if (is.null(input$group) & is.null(input$method)) geom_line(size = 2, alpha = 0.6)
  } + {
    if(!is.na(labels)[1]) geom_point(data = labels, aes(x = pos, y = lod))
  } + {
    if(!is.na(labels)[1]) geom_text(data = labels, aes(x = pos, y = lod, label = name), nudge_y = 1)
  } +
    facet_wrap(~ chr, ncol = ncol, scales = "free_x") +
    theme_minimal() +
    theme(strip.text = element_text(face = "bold", size = 12)) +
    scale_color_brewer(palette = "Set1") +
    labs(x = "Chromosome",
         y = "LOD",
         color = "Method")
    
}
```

```{r  fig.width=8, fig.height=6}
qtl_plot(input = out.2p, 
         model = "2part",
         chrs = c(1:3, 5:6, 13, 15),
         lod = summary(operm.2p, alpha=0.05)[1], 
         rug = TRUE, 
         ncol = 4,
         labels = as.data.frame(summary(out.2p, perms=operm.2p, alpha=0.05, pvalues=TRUE)))
```

```{r}
y <- listeria$pheno$logSurv
my <- max(y, na.rm=TRUE)
z <- as.numeric(y==my)
y[y==my] <- NA
listeria$pheno$logSurv2 <- y
listeria$pheno$binary <- z
plot(listeria)

out.p <- scanone(listeria, pheno.col=5, model="binary")
plot(out.p, out.2p, lodcolumn=c(1,2), chr=c(1,5,13,15), col=c("blue","red"))
```

```{r }
library(ggplot2)
library(tidyr)

qtl_plot <- function(input, model = "normal", chrs = NA, lod = NA, rug = FALSE, ncol = NA, labels = NA) {
  
  if (model == "2part") {
    input <- gather(input, group, lod, lod.p.mu:lod.mu)
  }
    
  if (!is.na(chrs)[1]) {
    input <- input[as.character(input$chr) %in% chrs, ]
  }
  
  if (is.na(ncol)) {
    ncol <- length(unique(input$chr))
  }
  
  if(!is.na(labels)[1]) {
    labels$name <- rownames(labels)
  }

  
  ggplot(input, aes(x = pos, y = lod)) + {
    if(!is.na(lod)) geom_hline(yintercept = lod, linetype = "dashed")
  } + {
    if(rug) geom_rug(size = 0.1, sides = "b")
  } + {
    if (!is.null(input$method)) geom_line(aes(color = method), size = 2, alpha = 0.6)
  } + {
    if (!is.null(input$group)) geom_line(aes(color = group), size = 2, alpha = 0.6)
  } + {
    if (is.null(input$group) & is.null(input$method)) geom_line(size = 2, alpha = 0.6)
  } + {
    if(!is.na(labels)[1]) geom_point(data = labels, aes(x = pos, y = lod))
  } + {
    if(!is.na(labels)[1]) geom_text(data = labels, aes(x = pos, y = lod, label = name), nudge_y = 1)
  } +
    facet_wrap(~ chr, ncol = ncol, scales = "free_x") +
    theme_minimal() +
    theme(strip.text = element_text(face = "bold", size = 12)) +
    scale_color_brewer(palette = "Set1") +
    labs(x = "Chromosome",
         y = "LOD",
         color = "Method")
    
}
```


```{r}
out.np1 <- scanone(listeria, model="np", ties.random=TRUE)
out.np2 <- scanone(listeria, model="np", ties.random=FALSE)
plot(out.np1, out.np2, col=c("blue","red"))
plot(out.2p, out.np1, out.np2, chr=c(1,5,13,15))
```

```{r  fig.width=8, fig.height=6}
qtl_plot(input = rbind(data.frame(out.np1, method = "out.2p"),
                       data.frame(out.np1, method = "np1"),
                       data.frame(out.np2, method = "np2")))
```




